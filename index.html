<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Heritage – Family Tree Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Lightweight graph library -->
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>

  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }

    :root {
      --bg-color: #111827;
      --sidebar-bg: #1f2933;
      --text-color: #f3f4f6;
      --border-color: #374151;
      --input-bg: #111827;
      --input-text: #e5e7eb;
      --cy-bg: #030712;
      --modal-bg: #1f2933;
    }

    body.light {
      --bg-color: #f4f6f8;
      --sidebar-bg: #ffffff;
      --text-color: #111827;
      --border-color: #dcdcdc;
      --input-bg: #ffffff;
      --input-text: #111827;
      --cy-bg: #f9fafb;
      --modal-bg: #ffffff;
    }

    body { 
      margin: 0; 
      display: flex; 
      flex-direction: row; 
      height: 100vh; 
      overflow: hidden; 
      background: var(--bg-color); 
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }

    #sidebar { 
      width: 300px; 
      padding: 16px; 
      background: var(--sidebar-bg); 
      border-right: 1px solid var(--border-color); 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
      z-index: 10; 
      overflow-y: auto;
    }

    #sidebar h2 { margin: 0 0 8px 0; font-size: 18px; }

    label { font-size: 13px; opacity: 0.8; }
    input, select { 
      padding: 8px; 
      font-size: 14px; 
      border: 1px solid var(--border-color); 
      border-radius: 4px; 
      width: 100%; 
      background: var(--input-bg);
      color: var(--input-text);
    }

    button { 
      padding: 12px; 
      border: none; 
      border-radius: 6px; 
      background: #2563eb; 
      color: white; 
      font-size: 14px; 
      cursor: pointer; 
      transition: opacity 0.2s, background 0.2s; 
      width: 100%;
    }
    button:hover { opacity: 0.9; }
    button.secondary { background: #6b7280; }
    button.danger { background: #ef4444; margin-top: 10px; }
    button:disabled { background: #4b5563; cursor: not-allowed; opacity: 0.5; }

    #instructions { font-size: 11px; opacity: 0.7; margin-top: auto; line-height: 1.4; padding-top: 20px; }
    #cy { flex: 1; background: var(--cy-bg); position: relative; }

    /* Modal Styling */
    #modalBackdrop { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.75); 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 1000; 
      padding: 20px;
    }
    
    #modal { 
      background: var(--modal-bg); 
      width: 500px; 
      max-width: 100%; 
      height: 85vh; 
      border-radius: 12px; 
      padding: 24px; 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
      box-shadow: 0 20px 50px rgba(0,0,0,0.3); 
      overflow-y: auto;
      position: relative;
    }

    #modalCloseX {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #ef4444;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
      border: none;
      line-height: 1;
      padding: 0;
    }
    
    #photoContainer {
      position: relative;
      align-self: center;
      width: 120px;
      height: 120px;
      margin-bottom: 10px;
    }

    #modal img { 
      width: 100%; 
      height: 100%; 
      border-radius: 50%; 
      object-fit: cover; 
      background: #374151; 
      border: 3px solid #2563eb;
      display: block;
    }

    #addPhotoBtn {
      position: absolute;
      right: -5px;
      bottom: 5px;
      background: #2563eb;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--modal-bg);
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
    }

    #validationError { color: #ef4444; font-size: 12px; display: none; text-align: center; }

    @media (max-width: 768px) {
      body { flex-direction: column; }
      #sidebar { width: 100%; height: auto; max-height: 40vh; border-right: none; border-bottom: 1px solid var(--border-color); }
      #modal { width: 100%; height: 90vh; }
    }
  </style>
</head>
<body class="dark">

  <div id="sidebar">
    <h2>Heritage Tree</h2>

    <div>
      <label>Search Members</label>
      <input id="searchBar" placeholder="Find ancestor..." />
    </div>

    <hr style="width: 100%; border: 0; border-top: 1px solid var(--border-color); margin: 8px 0;" />

    <label>First name</label>
    <input id="firstName" placeholder="First" />

    <label>Last name</label>
    <input id="lastName" placeholder="Last" />

    <label>Birth date</label>
    <input id="birthDate" type="date" />

    <button id="addNode">Create Member</button>

    <div style="margin-top: 8px;">
      <label>Connection Logic</label>
      <select id="relType">
        <option value="parent-child">Parent → Child</option>
        <option value="partner">Partner (Marriage)</option>
      </select>
    </div>
    <button id="connectNodes" class="secondary" disabled>Connect Selected</button>
    
    <button id="autoLayout" class="secondary">Re-Align Tree (Hierarchy)</button>
    <button id="disconnectNodes" class="secondary" disabled>Remove Link</button>
    <button id="toggleTheme" class="secondary">Toggle Light/Dark</button>
    
    <div style="display: flex; gap: 8px;">
      <button id="saveTree" class="secondary">Export JSON</button>
      <button id="importTrigger" class="secondary" onclick="document.getElementById('importTree').click()">Import</button>
    </div>
    <input id="importTree" type="file" accept="application/json" style="display: none;" />

    <div id="instructions">
      <strong>Connecting:</strong><br />
      1. First select one node, and while holding CNTRL select a second node.<br />
      1. To connect a child to parents: Connect Mother to Father as "Partner". A pink dot (Union) appears. <br />
      2. Then select a Parent, then the Child, and click "Connect". The line will route through the Union.<br />
      3. Use "Re-Align" to group partners closely.
    </div>
  </div>

  <div id="cy"></div>

  <div id="modalBackdrop">
    <div id="modal">
      <button id="modalCloseX" title="Close">✕</button>
      <h3 style="margin: 0; text-align: center;">Member Details</h3>
      
      <div id="photoContainer">
        <img id="photoPreview" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" />
        <button id="addPhotoBtn" title="Upload Photo">+</button>
      </div>
      <input id="photoInput" type="file" accept="image/*" style="display: none;" />

      <label>First name</label>
      <input id="modalFirstName" placeholder="First" />

      <label>Last name</label>
      <input id="modalLastName" placeholder="Last" />

      <label>Birth date</label>
      <input id="modalBirthDate" type="date" />

      <label>Death date</label>
      <input id="modalDeathDate" type="date" />
      
      <div id="validationError">Chronological error: Death precedes birth.</div>

      <div style="flex-grow: 1;"></div>

      <button id="saveCharacter">Save Changes</button>
      <button id="closeModal" class="secondary">Cancel</button>
      <button id="deleteNode" class="danger">Delete Member</button>
    </div>
  </div>

  <script>
    'use strict';

    let activeNodeId = null; 
    let selectionOrder = []; // Track the order of selection

    const cy = cytoscape({
      container: document.getElementById('cy'),
      style: [
        {
          selector: 'node[type="person"]',
          style: {
            'shape': 'round-rectangle',
            'background-color': '#1f2933',
            'border-width': 1,
            'border-color': '#9ca3af',
            'label': 'data(label)',
            'text-wrap': 'wrap',
            'text-max-width': 160,
            'text-valign': 'bottom',
            'text-halign': 'center',
            'text-margin-y': 8,
            'color': '#f9fafb',
            'padding': 10,
            'font-size': 14, 
            'font-weight': 'bold',
            'width': 100,
            'height': 120,
            'z-index': 10
          }
        },
        {
          selector: 'node[type="union"]',
          style: {
            'shape': 'ellipse',
            'width': 10,
            'height': 10,
            'background-color': '#ec4899',
            'z-index': 5
          }
        },
        {
          selector: 'node[photo]',
          style: {
            'background-image': function(node) {
              const p = node.data('photo');
              return (p && p.length > 0) ? p : 'none';
            },
            'background-fit': 'cover',
            'background-image-opacity': function(node) {
              return node.data('photo') ? 1 : 0;
            }
          }
        },
        {
          selector: 'node[isDeceased]',
          style: {
            'background-color': '#374151',
            'border-style': 'double',
            'border-width': 3,
            'opacity': 0.8
          }
        },
        {
          selector: 'node[type="badge"]',
          style: {
            'shape': 'ellipse',
            'width': 22,
            'height': 22,
            'background-color': '#2563eb',
            'color': '#ffffff',
            'font-size': 14,
            'font-weight': 'bold',
            'label': '+',
            'text-valign': 'center',
            'text-halign': 'center',
            'z-index': 20,
            'border-width': 2,
            'border-color': '#ffffff'
          }
        },
        { 
          selector: 'node[type="person"]:selected', 
          style: { 'border-width': 4, 'border-color': '#3b82f6' } 
        },
        {
          selector: 'node.highlight',
          style: { 'border-color': '#fbbf24', 'border-width': 6 }
        },
        { 
          selector: 'edge', 
          style: { 
            'width': 2, 
            'line-color': '#4b5563', 
            'curve-style': 'taxi', 
            'taxi-direction': 'vertical',
            'target-arrow-shape': 'triangle', 
            'target-arrow-color': '#4b5563'
          } 
        },
        {
          selector: 'edge[relType="partner"]',
          style: {
            'line-style': 'solid',
            'target-arrow-shape': 'none',
            'line-color': '#ec4899',
            'width': 3,
            'curve-style': 'straight'
          }
        },
        {
          selector: 'edge:selected',
          style: { 'line-color': '#3b82f6', 'target-arrow-color': '#3b82f6', 'width': 4 }
        }
      ],
      layout: { name: 'preset' }, 
      wheelSensitivity: 0.1
    });

    function updateBadgePosition(personNode) {
      const badge = cy.getElementById(personNode.id() + '_badge');
      if (badge.empty()) return;
      const pos = personNode.position();
      const w = personNode.width();
      const h = personNode.height();
      badge.position({ x: pos.x + (w / 2), y: pos.y - (h / 2) });
    }

    function buildLabel(first, ln, birth, death) {
      let labelParts = [];
      const name = [first, ln].filter(x => x && x.trim()).join(' ').trim();
      if (name) labelParts.push(name);
      
      let lifespan = "";
      if (birth) lifespan += new Date(birth).getFullYear();
      if (death) lifespan += " – " + new Date(death).getFullYear();
      else if (birth) lifespan += " – ";
      
      if (lifespan) labelParts.push(lifespan);
      return labelParts.join('\n');
    }

    function createBadge(personNode) {
      const badgeId = personNode.id() + '_badge';
      if(cy.getElementById(badgeId).empty()) {
        cy.add({
          group: 'nodes',
          data: { id: badgeId, type: 'badge', parentId: personNode.id() },
          grabbable: false,
          selectable: false
        });
      }
      updateBadgePosition(personNode);
    }

    cy.on('position', 'node[type="person"]', (evt) => updateBadgePosition(evt.target));

    const addNodeBtn = document.getElementById('addNode');
    const connectBtn = document.getElementById('connectNodes');
    const disconnectBtn = document.getElementById('disconnectNodes');
    const toggleThemeBtn = document.getElementById('toggleTheme');
    const autoLayoutBtn = document.getElementById('autoLayout');
    const searchBar = document.getElementById('searchBar');
    const saveTreeBtn = document.getElementById('saveTree');
    const importTreeInput = document.getElementById('importTree');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalFirstName = document.getElementById('modalFirstName');
    const modalLastName = document.getElementById('modalLastName');
    const modalBirthDate = document.getElementById('modalBirthDate');
    const modalDeathDate = document.getElementById('modalDeathDate');
    const validationError = document.getElementById('validationError');
    const photoInput = document.getElementById('photoInput');
    const photoPreview = document.getElementById('photoPreview');
    const saveCharacterBtn = document.getElementById('saveCharacter');
    const closeModalBtn = document.getElementById('closeModal');
    const deleteNodeBtn = document.getElementById('deleteNode');

    function updateActionButtons() {
      const selectedPeople = cy.nodes('node[type="person"]:selected');
      const selectedEdges = cy.edges(':selected');
      
      connectBtn.disabled = selectedPeople.length !== 2;
      
      // Determine if "Remove Link" should be active
      let canRemove = selectedEdges.length > 0;
      
      // If exactly two people are selected, check if they have a direct or union-mediated link
      if (!canRemove && selectedPeople.length === 2) {
          const p1 = selectedPeople[0];
          const p2 = selectedPeople[1];
          // Check for direct edges between them
          const directEdges = p1.edgesWith(p2);
          if (directEdges.nonempty()) {
              canRemove = true;
          } else {
              // Check for edges through a shared Union node
              const unions = p1.neighborhood('node[type="union"]');
              unions.forEach(u => {
                  if (u.edgesWith(p2).nonempty()) canRemove = true;
              });
          }
      }
      
      disconnectBtn.disabled = !canRemove;
    }

    cy.on('select', 'node[type="person"]', (evt) => {
      selectionOrder.push(evt.target);
      if (selectionOrder.length > 2) selectionOrder.shift();
      updateActionButtons();
    });

    cy.on('unselect', 'node[type="person"]', (evt) => {
      selectionOrder = selectionOrder.filter(n => n.id() !== evt.target.id());
      updateActionButtons();
    });

    cy.on('select unselect', 'edge', updateActionButtons);

    searchBar.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      cy.nodes('[type="person"]').forEach(node => {
        const match = (node.data('label') || '').toLowerCase().includes(query);
        query && match ? node.addClass('highlight') : node.removeClass('highlight');
      });
    });

    addNodeBtn.addEventListener('click', () => {
      const f = document.getElementById('firstName');
      const l = document.getElementById('lastName');
      const b = document.getElementById('birthDate');
      if (!f.value.trim() && !l.value.trim()) return;
      const id = 'n' + Date.now();
      const person = cy.add({
        group: 'nodes',
        data: { id, type: 'person', label: buildLabel(f.value, l.value, b.value, ''), firstName: f.value, lastName: l.value, birthDate: b.value, deathDate: '', isDeceased: false, photo: '' },
        position: { x: 100 + Math.random() * 100, y: 100 + Math.random() * 100 }
      });
      createBadge(person);
      f.value = ''; l.value = ''; b.value = '';
      updateActionButtons();
    });

    connectBtn.addEventListener('click', () => {
      if (selectionOrder.length !== 2) return;
      const s = selectionOrder[0]; // First selected is Parent
      const t = selectionOrder[1]; // Second selected is Child
      const type = document.getElementById('relType').value;
      
      if (type === 'partner') {
        const unionId = `u_${s.id()}_${t.id()}`;
        const midX = (s.position().x + t.position().x) / 2;
        const midY = (s.position().y + t.position().y) / 2;
        cy.add([
          { group: 'nodes', data: { id: unionId, type: 'union' }, position: { x: midX, y: midY } },
          { group: 'edges', data: { id: `e_${s.id()}_u`, source: s.id(), target: unionId, relType: 'partner' } },
          { group: 'edges', data: { id: `e_${t.id()}_u`, source: t.id(), target: unionId, relType: 'partner' } }
        ]);
      } else {
        const unions = s.neighborhood('node[type="union"]');
        const sourceId = unions.nonempty() ? unions.first().id() : s.id();
        cy.add({ 
          group: 'edges', 
          data: { 
            id: 'e' + Date.now(), 
            source: sourceId, 
            target: t.id(), 
            relType: 'parent-child' 
          } 
        });
      }
      cy.elements().unselect();
      selectionOrder = [];
      updateActionButtons();
    });

    autoLayoutBtn.addEventListener('click', () => {
      const layout = cy.layout({
        name: 'breadthfirst',
        directed: true,
        padding: 80,
        spacingFactor: 1.1, 
        animate: true,
        stop: () => {
          cy.nodes('node[type="union"]').forEach(unionNode => {
            const partners = unionNode.neighborhood('node[type="person"]');
            if (partners.length === 2) {
              const p1 = partners[0];
              const p2 = partners[1];
              const unionPos = unionNode.position();
              p1.position({ x: unionPos.x - 70, y: unionPos.y });
              p2.position({ x: unionPos.x + 70, y: unionPos.y });
            }
          });
          cy.nodes('[type="person"]').forEach(n => updateBadgePosition(n));
        }
      });
      layout.run();
    });

    disconnectBtn.addEventListener('click', () => {
      const selectedEdges = cy.edges(':selected');
      if (selectedEdges.nonempty()) {
          selectedEdges.remove();
      } else {
          // If no edges selected, check nodes in selectionOrder
          const selectedPeople = cy.nodes('node[type="person"]:selected');
          if (selectedPeople.length === 2) {
              const p1 = selectedPeople[0];
              const p2 = selectedPeople[1];
              // Remove direct edges
              p1.edgesWith(p2).remove();
              // Remove edges mediated by union
              const unions = p1.neighborhood('node[type="union"]');
              unions.forEach(u => u.edgesWith(p2).remove());
          }
      }
      updateActionButtons();
    });

    toggleThemeBtn.addEventListener('click', () => {
      document.body.classList.toggle('light');
    });

    cy.on('tap', 'node[type="badge"]', (evt) => {
      const parent = cy.getElementById(evt.target.data('parentId'));
      if (parent.nonempty()) openModal(parent);
    });

    function openModal(node) {
      activeNodeId = node.id();
      modalFirstName.value = node.data('firstName') || '';
      modalLastName.value = node.data('lastName') || '';
      modalBirthDate.value = node.data('birthDate') || '';
      modalDeathDate.value = node.data('deathDate') || '';
      photoPreview.src = node.data('photo') || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
      validationError.style.display = 'none';
      modalBackdrop.style.display = 'flex';
    }

    document.getElementById('modalCloseX').addEventListener('click', () => modalBackdrop.style.display = 'none');
    closeModalBtn.addEventListener('click', () => modalBackdrop.style.display = 'none');
    
    saveCharacterBtn.addEventListener('click', () => {
      const node = cy.getElementById(activeNodeId);
      const b = modalBirthDate.value;
      const d = modalDeathDate.value;
      if (b && d && new Date(d) < new Date(b)) { validationError.style.display = 'block'; return; }
      node.data({ firstName: modalFirstName.value, lastName: modalLastName.value, birthDate: b, deathDate: d, isDeceased: !!d, label: buildLabel(modalFirstName.value, modalLastName.value, b, d) });
      updateBadgePosition(node);
      modalBackdrop.style.display = 'none';
    });

    document.getElementById('addPhotoBtn').addEventListener('click', () => photoInput.click());

    photoInput.addEventListener('change', () => {
      const file = photoInput.files[0];
      if (!file) return;
      const r = new FileReader();
      r.onload = () => { photoPreview.src = r.result; cy.getElementById(activeNodeId).data('photo', r.result); };
      r.readAsDataURL(file);
    });

    deleteNodeBtn.addEventListener('click', () => {
      const node = cy.getElementById(activeNodeId);
      const badge = cy.getElementById(activeNodeId + '_badge');
      node.remove();
      badge.remove();
      modalBackdrop.style.display = 'none';
      updateActionButtons();
    });

    saveTreeBtn.addEventListener('click', () => {
      const nodes = cy.nodes().map(n => ({ data: n.data(), position: n.position() }));
      const edges = cy.edges().map(e => ({ data: e.data() }));
      const blob = new Blob([JSON.stringify({ nodes, edges })], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'tree.json'; a.click();
    });

    importTreeInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      const r = new FileReader();
      r.onload = () => {
        const json = JSON.parse(r.result);
        cy.elements().remove();
        cy.add(json.nodes.map(n => ({ group: 'nodes', data: n.data, position: n.position })));
        cy.add(json.edges.map(e => ({ group: 'edges', data: e.data })));
        cy.nodes('[type="person"]').forEach(n => createBadge(n));
        updateActionButtons();
      };
      r.readAsText(file);
    });

    window.addEventListener('resize', () => cy.resize());
  </script>
</body>
</html>