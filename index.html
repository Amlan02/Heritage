<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Heritage – Family Tree Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, sans-serif; }
    :root { --bg: #111827; --sb-bg: #1f2933; --txt: #f3f4f6; --brd: #374151; --inp-bg: #111827; --cy-bg: #030712; --mod-bg: #1f2933; --grid: rgba(255,255,255,0.05); }
    body.light { --bg: #f4f6f8; --sb-bg: #fff; --txt: #111827; --brd: #dcdcdc; --inp-bg: #fff; --cy-bg: #f9fafb; --mod-bg: #fff; --grid: rgba(0,0,0,0.05); }
    body { margin: 0; display: flex; height: 100vh; overflow: hidden; background: var(--bg); color: var(--txt); transition: background 0.3s; }
    
    /* Layout & Sidebar */
    #sidebar { width: 220px; min-width: 220px; padding: 16px; background: var(--sb-bg); border-right: 1px solid var(--brd); display: flex; flex-direction: column; gap: 12px; z-index: 100; overflow-y: auto; }
    .flex-row { display: flex; justify-content: space-between; align-items: center; }
    #sidebar h2 { margin: 0; font-size: 18px; }
    
    /* Inputs & Buttons */
    input, button { width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--brd); background: var(--inp-bg); color: var(--txt); margin-bottom: 8px; font-size: 14px; }
    button { border: none; background: #2563eb; color: #fff; font-weight: 600; cursor: pointer; transition: 0.2s; padding: 12px; }
    button:hover { opacity: 0.9; } button:disabled { opacity: 0.3; cursor: not-allowed; }
    .btn-sec { background: #6b7280; } .btn-dan { background: #ef4444; }
    #searchToggleBtn { width: 36px; height: 36px; padding: 0; background: transparent; display: flex; align-items: center; justify-content: center; }
    #searchWrapper { display: none; margin-top: 8px; }
    label { font-size: 13px; opacity: 0.8; margin-bottom: 4px; display: block; }
    hr { width: 100%; border: 0; border-top: 1px solid var(--brd); margin: 4px 0; }

    /* Canvas & Modals */
    #cy { flex: 1; background: var(--cy-bg) linear-gradient(var(--grid) 1px, transparent 1px) 0 0 / 20px 20px, linear-gradient(90deg, var(--grid) 1px, transparent 1px) 0 0 / 20px 20px; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .modal-content { background: var(--mod-bg); padding: 24px; border-radius: 12px; position: relative; width: 400px; max-width: 95%; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
    .close-x { position: absolute; top: 12px; right: 12px; background: #ef4444; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1; }
    
    /* Radial Menu */
    #radialMenuContainer { position: relative; width: 400px; height: 400px; display: flex; align-items: center; justify-content: center; }
    .radial-btn { position: absolute; width: 80px; height: 80px; border-radius: 50%; background: #374151; border: 2px solid var(--brd); font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center; text-align: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    .rad-top { top: 20px; left: 50%; transform: translateX(-50%); background: #8b5cf6; }
    .rad-bottom { bottom: 20px; left: 50%; transform: translateX(-50%); background: #ec4899; }
    .rad-left { top: 50%; left: 20px; transform: translateY(-50%); background: #10b981; }
    .rad-right { top: 50%; right: 20px; transform: translateY(-50%); background: #10b981; }
    .rad-partner { top: 30px; right: 30px; background: #f59e0b; }
    .rad-center { width: 100px; height: 100px; border: 2px dashed var(--brd); display: flex; align-items: center; justify-content: center; color: #9ca3af; z-index: -1; border-radius: 50%; }

    /* Photo */
    #photoContainer { position: relative; align-self: center; width: 120px; height: 120px; margin-bottom: 10px; }
    #photoContainer img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid #2563eb; background: #374151; }
    #addPhotoBtn { position: absolute; right: 0; bottom: 0; width: 32px; height: 32px; border-radius: 50%; background: #2563eb; border: 2px solid var(--mod-bg); display: flex; align-items: center; justify-content: center; cursor: pointer; }

    @media (max-width: 768px) { body { flex-direction: column; } #sidebar { width: 100%; height: auto; max-height: 40vh; border-right: 0; border-bottom: 1px solid var(--brd); } }
  </style>
</head>
<body class="dark">
  <div id="sidebar">
    <div class="flex-row">
      <h2>Heritage Tree</h2>
      <button id="searchToggleBtn"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg></button>
    </div>
    <div id="searchWrapper"><input id="searchBar" placeholder="Find Ancestor..." /></div>
    <hr />
    <div style="display:flex; flex-direction:column; gap:8px;">
      <button id="btnMarriage" style="background:#ec4899" disabled>Link Marriage</button>
      <button id="btnChild" style="background:#86efac; color:#064e3b" disabled>Link Child</button>
      <button id="btnAutoAlign" style="background:#8b5cf6">Auto Align</button>
    </div>
    <hr />
    <button id="disconnectNodes" class="btn-sec" disabled>Disconnect</button>
    <button id="toggleTheme" class="btn-sec">Toggle Theme</button>
    <div style="display:flex; gap:8px;"><button id="saveTree" class="btn-sec">Export</button><button onclick="$('importTree').click()" class="btn-sec">Import</button></div>
    <input id="importTree" type="file" accept=".json" style="display:none" />
    <button id="clearBoard" class="btn-dan" style="margin-top:auto">CLEAR BOARD</button>
    <div id="instructions" style="font-size:11px; opacity:0.7; margin-top:10px">Right-click bg to create. Right-click node to add family.</div>
  </div>
  
  <div id="cy"></div>

  <!-- Create Modal -->
  <div id="createModal" class="modal-backdrop">
    <div class="modal-content">
      <button class="close-x" onclick="toggleModal('createModal',0)">✕</button>
      <h3 style="text-align:center; margin-top:0">New Member</h3>
      <input id="newFn" placeholder="First Name" /><input id="newLn" placeholder="Last Name" /><input id="newDob" type="date" />
      <button id="confirmCreate">Create</button>
    </div>
  </div>

  <!-- Radial Menu -->
  <div id="radialModal" class="modal-backdrop" onclick="if(event.target===this) toggleModal('radialModal',0)">
    <div id="radialMenuContainer">
      <button class="radial-btn rad-top" onclick="radialAct('parent')">Add<br>Parent</button>
      <button class="radial-btn rad-left" onclick="radialAct('sibling-left')">Add<br>Sibling (L)</button>
      <div class="rad-center">TARGET</div>
      <button class="radial-btn rad-right" onclick="radialAct('sibling-right')">Add<br>Sibling (R)</button>
      <button class="radial-btn rad-bottom" onclick="radialAct('child')">Add<br>Child</button>
      <button class="radial-btn rad-partner" onclick="radialAct('partner')">Add<br>Partner</button>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal-backdrop">
    <div class="modal-content" style="height: 85vh; width: 500px;">
      <button class="close-x" onclick="toggleModal('editModal',0)">✕</button>
      <h3 style="text-align:center; margin:0 0 10px 0">Edit Details</h3>
      <div id="photoContainer">
        <img id="photoPreview" src="" />
        <div id="addPhotoBtn" onclick="$('photoInput').click()">+</div>
      </div>
      <input id="photoInput" type="file" accept="image/*" style="display:none" />
      <input id="editFn" placeholder="First" /><input id="editLn" placeholder="Last" />
      <label>Birth</label><input id="editDob" type="date" />
      <label>Death</label><input id="editDod" type="date" />
      <div style="flex:1"></div>
      <button id="saveEdit">Save</button>
      <button class="btn-sec" onclick="toggleModal('editModal',0)">Cancel</button>
      <button id="delNode" class="btn-dan">Delete</button>
    </div>
  </div>

  <script>
    'use strict';
    const $ = id => document.getElementById(id);
    const toggleModal = (id, show) => $(id).style.display = show ? 'flex' : 'none';
    const snap = p => ({ x: Math.round(p.x/20)*20, y: Math.round(p.y/20)*20 });
    const uuid = (p='p') => p + '_' + Date.now() + Math.floor(Math.random()*1000);
    const emptyImg = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';

    let selOrder = [], activeId = null, ctxPos = {x:0,y:0}, ctxNode = null;

    const cy = cytoscape({
      container: $('cy'),
      selectionType: 'additive',
      wheelSensitivity: 0.1,
      style: [
        { selector: 'node[type="person"]', style: { 'shape': 'round-rectangle', 'width': 100, 'height': 120, 'background-color': '#1f2933', 'border-width': 1, 'border-color': '#9ca3af', 'label': 'data(label)', 'text-wrap': 'wrap', 'text-valign': 'bottom', 'text-halign': 'center', 'text-margin-y': 8, 'color': '#f9fafb', 'padding': 10, 'font-size': 14, 'font-weight': 'bold' } },
        { selector: 'node[photo]', style: { 'background-image': n => n.data('photo') || 'none', 'background-fit': 'cover', 'background-image-opacity': n => n.data('photo') ? 1 : 0 } },
        { selector: 'node[isDeceased]', style: { 'background-color': '#374151', 'border-style': 'double', 'border-width': 3 } },
        { selector: 'node[type="union"]', style: { 'shape': 'ellipse', 'width': 14, 'height': 14, 'background-color': '#ec4899', 'border-width': 2, 'border-color': '#fff' } },
        { selector: '.overlay-btn', style: { 'shape': 'ellipse', 'width': 22, 'height': 22, 'color': '#fff', 'text-valign': 'center', 'text-halign': 'center', 'border-width': 2, 'border-color': '#fff' } },
        { selector: 'node[type="badge"]', style: { 'background-color': '#2563eb', 'label': '+' } },
        { selector: 'node[type="branchButton"]', style: { 'background-color': '#10b981', 'label': '▼' } },
        { selector: 'node.collapsed-btn', style: { 'background-color': '#f59e0b', 'label': '▲' } },
        { selector: ':selected', style: { 'border-width': 4, 'border-color': '#3b82f6', 'line-color': '#3b82f6' } },
        { selector: 'edge', style: { 'width': 2, 'line-color': '#4b5563', 'curve-style': 'taxi', 'taxi-direction': 'vertical', 'target-arrow-shape': 'triangle' } },
        { selector: 'edge[relType="partner"]', style: { 'target-arrow-shape': 'none', 'line-color': '#ec4899', 'width': 3, 'curve-style': 'straight' } },
        { selector: '.hidden', style: { 'display': 'none' } }
      ]
    });

    // --- Core Logic ---
    function buildLabel(f, l, b, d) {
      const n = [f, l].filter(s=>s?.trim()).join(' ');
      const y = d ? `${new Date(b).getFullYear()}–${new Date(d).getFullYear()}` : (b ? `${new Date(b).getFullYear()}–` : '');
      return [n, y].filter(Boolean).join('\n');
    }

    function addPerson(data, pos) {
      data = data || {};
      const id = data.id || uuid();
      // Add Person and Overlays in one op (if batched by caller)
      const p = snap(pos || {x:0, y:0});
      const node = cy.add({ group: 'nodes', position: p, data: { ...data, id, type: 'person', label: buildLabel(data.firstName, data.lastName, data.birthDate, data.deathDate), photo: data.photo || '' } });
      cy.add([
        { group: 'nodes', classes: 'overlay-btn', data: { id: id+'_badge', type: 'badge', parentId: id }, position: { x: p.x+50, y: p.y-60 }, grabbable: false },
        { group: 'nodes', classes: 'overlay-btn', data: { id: id+'_branch', type: 'branchButton', parentId: id }, position: { x: p.x, y: p.y-60 }, grabbable: false }
      ]);
      return node;
    }

    // --- Efficient Overlay Updates ---
    let rafId = null, updateQueue = new Set();
    function flushUpdates() {
      cy.batch(() => {
        updateQueue.forEach(node => {
          const p = node.position();
          cy.getElementById(node.id()+'_badge').position({ x: p.x+50, y: p.y-60 });
          cy.getElementById(node.id()+'_branch').position({ x: p.x, y: p.y-60 });
        });
      });
      updateQueue.clear();
      rafId = null;
    }
    
    cy.on('position', 'node[type="person"]', e => {
      updateQueue.add(e.target);
      if (!rafId) rafId = requestAnimationFrame(flushUpdates);
    });

    // --- Interaction ---
    cy.on('cxttap', e => {
      if (e.target === cy) {
        ctxPos = snap(e.position);
        $('newFn').value = $('newLn').value = $('newDob').value = '';
        toggleModal('createModal', 1);
      } else if (e.target.data('type') === 'person') {
        ctxNode = e.target;
        toggleModal('radialModal', 1);
      }
    });

    $('confirmCreate').onclick = () => {
      if (!$('newFn').value && !$('newLn').value) return alert('Name required');
      cy.batch(() => addPerson({ firstName: $('newFn').value, lastName: $('newLn').value, birthDate: $('newDob').value }, ctxPos));
      toggleModal('createModal', 0);
    };

    window.radialAct = (act) => {
      if (!ctxNode) return;
      cy.batch(() => { // Batch all operations
        const origin = ctxNode, oPos = origin.position();
        const newPos = snap({ 
          x: oPos.x + (act.includes('sibling') ? (act.includes('left')?-220:220) : (act==='partner'?200 : (act==='parent'?-100:0))),
          y: oPos.y + (act === 'parent' ? -300 : (act === 'child' ? 300 : 0))
        });
        
        const newNode = addPerson({ firstName: 'New', lastName: 'Member' }, newPos);
        const addEdge = (s, t, r) => cy.add({ group: 'edges', data: { source: s, target: t, relType: r } });
        const getUnion = (n, r, d) => n.connectedEdges(`edge[${d}="${n.id()}"][relType="${r}"]`).map(e=>e.source()).first();

        if (act === 'parent') {
          let u = getUnion(origin, 'parent-child', 'target');
          if (!u || u.empty()) {
            u = cy.add({ group: 'nodes', data: { id: uuid('u'), type: 'union' }, position: snap({x: (oPos.x+newPos.x)/2, y: (oPos.y+newPos.y)/2+40}) });
            addEdge(u.id(), origin.id(), 'parent-child');
          }
          addEdge(newNode.id(), u.id(), 'partner');
        } else if (act.includes('sibling')) {
          let u = getUnion(origin, 'parent-child', 'target');
          if (u && u.nonempty()) addEdge(u.id(), newNode.id(), 'parent-child');
        } else if (act === 'child') {
          const pEdge = origin.connectedEdges('edge[relType="partner"]');
          let u = pEdge.nonempty() ? pEdge[0].target() : cy.add({ group: 'nodes', data: { id: uuid('u'), type: 'union' }, position: snap({x: oPos.x, y: oPos.y+80}) });
          if (pEdge.empty()) addEdge(origin.id(), u.id(), 'partner');
          addEdge(u.id(), newNode.id(), 'parent-child');
        } else if (act === 'partner') {
          const u = cy.add({ group: 'nodes', data: { id: uuid('u'), type: 'union' }, position: snap({x: (oPos.x+newPos.x)/2, y: oPos.y+80}) });
          addEdge(origin.id(), u.id(), 'partner');
          addEdge(newNode.id(), u.id(), 'partner');
        }
        setTimeout(() => openEdit(newNode), 50);
      });
      toggleModal('radialModal', 0);
    };

    // --- Branch Visibility ---
    function getBranch(node, recursive, visited = new Set()) {
      if (visited.has(node.id())) return cy.collection();
      visited.add(node.id());
      let set = cy.collection();
      node.connectedEdges('edge[target="'+node.id()+'"][relType="parent-child"]').forEach(e => {
        const u = e.source();
        set = set.add(e).add(u);
        u.connectedEdges('edge[target!="'+node.id()+'"][relType="parent-child"]').forEach(se => {
            set = set.add(se).add(se.target()).add(cy.getElementById(se.target().id()+'_badge')).add(cy.getElementById(se.target().id()+'_branch'));
        });
        u.connectedEdges('edge[relType="partner"]').forEach(pe => {
            const p = pe.source();
            set = set.add(pe).add(p).add(cy.getElementById(p.id()+'_badge')).add(cy.getElementById(p.id()+'_branch'));
            if (recursive) set = set.add(getBranch(p, true, visited));
        });
      });
      return set;
    }

    cy.on('tap', 'node[type="branchButton"]', e => {
      const btn = e.target, p = cy.getElementById(btn.data('parentId'));
      if (btn.hasClass('collapsed-btn')) {
        getBranch(p, false).removeClass('hidden'); // Step-wise show
        btn.removeClass('collapsed-btn');
      } else {
        const branch = getBranch(p, true); // Recursive hide
        branch.addClass('hidden');
        branch.filter('node[type="branchButton"]').addClass('collapsed-btn');
        btn.addClass('collapsed-btn');
      }
    });

    // --- Auto Align ---
    $('btnAutoAlign').onclick = () => {
      cy.batch(() => {
        const nodes = cy.nodes('[type="person"]');
        if (!nodes.length) return;
        const depths = new Map();
        const getDepth = n => {
          if (depths.has(n.id())) return depths.get(n.id());
          let d = 0;
          n.connectedEdges('edge[source="'+n.id()+'"][relType="partner"]').targets().forEach(u => {
            u.connectedEdges('edge[relType="parent-child"]').targets().forEach(c => d = Math.max(d, getDepth(c)));
          });
          depths.set(n.id(), d + 1); return d + 1;
        };
        nodes.forEach(getDepth);
        const maxD = Math.max(...depths.values());
        nodes.forEach(n => depths.set(n.id(), maxD - depths.get(n.id()))); 

        let curX = 0, vis = new Set();
        const layout = (n, gen) => {
          if (vis.has(n.id())) return;
          vis.add(n.id());
          const unions = n.connectedEdges('edge[source="'+n.id()+'"][relType="partner"]').targets();
          if (!unions.length) { n.position(snap({x: curX, y: gen*300})); curX += 220; updateQueue.add(n); return; }
          
          let cxSum = 0, cCount = 0;
          unions.forEach(u => {
            u.connectedEdges('edge[relType="parent-child"]').targets().sort((a,b) => (new Date(a.data('birthDate')||'9999') - new Date(b.data('birthDate')||'9999'))).forEach(c => {
              layout(c, gen + 1);
              cxSum += c.position().x; cCount++;
            });
          });

          const mid = cCount ? cxSum/cCount : curX;
          if (!cCount) curX += 220;
          n.position(snap({x: mid - 80, y: gen*300})); updateQueue.add(n);
          
          unions.forEach(u => {
            const ptr = u.connectedEdges('edge[relType="partner"]').sources().filter(p => p.id() !== n.id()).first();
            if (ptr.nonempty()) { vis.add(ptr.id()); ptr.position(snap({x: mid + 80, y: gen*300})); updateQueue.add(ptr); }
            u.position(snap({x: mid, y: gen*300 + 80}));
          });
        };
        nodes.filter(n => !n.connectedEdges('edge[target="'+n.id()+'"][relType="parent-child"]').length).forEach(r => layout(r, depths.get(r.id())));
      });
      if(!rafId) rafId = requestAnimationFrame(flushUpdates); // Ensure overlays sync after batch
      cy.fit();
    };

    // --- Modal & Edit Logic ---
    function openEdit(n) {
      activeId = n.id();
      $('editFn').value = n.data('firstName')||''; $('editLn').value = n.data('lastName')||'';
      $('editDob').value = n.data('birthDate')||''; $('editDod').value = n.data('deathDate')||'';
      $('photoPreview').src = n.data('photo') || emptyImg;
      toggleModal('editModal', 1);
    }

    $('saveEdit').onclick = () => {
      const d = { firstName: $('editFn').value, lastName: $('editLn').value, birthDate: $('editDob').value, deathDate: $('editDod').value };
      cy.getElementById(activeId).data({ ...d, isDeceased: !!d.deathDate, label: buildLabel(d.firstName, d.lastName, d.birthDate, d.deathDate) });
      toggleModal('editModal', 0);
    };

    $('delNode').onclick = () => {
      cy.batch(() => {
          cy.getElementById(activeId).remove();
          cy.getElementById(activeId+'_badge').remove();
          cy.getElementById(activeId+'_branch').remove();
      });
      toggleModal('editModal', 0);
    };

    $('photoInput').onchange = e => {
      const r = new FileReader();
      r.onload = () => { $('photoPreview').src = r.result; cy.getElementById(activeId).data('photo', r.result); };
      if(e.target.files[0]) r.readAsDataURL(e.target.files[0]);
    };

    // --- General Events ---
    cy.on('tap', 'node[type="badge"]', e => openEdit(cy.getElementById(e.target.data('parentId'))));
    cy.on('dragfree', 'node', e => e.target.position(snap(e.target.position())));

    cy.on('select unselect', () => {
      const s = cy.nodes(':selected');
      $('btnMarriage').disabled = $('btnChild').disabled = s.length !== 2;
      $('disconnectNodes').disabled = !s.length;
      if (s.length > 0 && s.last().data('type') === 'person') {
         if(!selOrder.includes(s.last())) selOrder.push(s.last());
         if(selOrder.length > 2) selOrder.shift().unselect();
      } else selOrder = [];
    });

    $('btnMarriage').onclick = () => {
      cy.batch(() => {
        const [s,t] = selOrder.slice(-2);
        const u = cy.add({group:'nodes', data:{id:uuid('u'), type:'union'}, position:snap({x:(s.position().x+t.position().x)/2, y:(s.position().y+t.position().y)/2+80})});
        cy.add([{group:'edges', data:{source:s.id(), target:u.id(), relType:'partner'}}, {group:'edges', data:{source:t.id(), target:u.id(), relType:'partner'}}]);
      });
      cy.elements().unselect();
    };

    $('btnChild').onclick = () => {
      const [s,t] = selOrder.slice(-2);
      if(t.data('type')!=='person') return;
      const uId = s.data('type')==='union' ? s.id() : s.neighborhood('node[type="union"]').first().id();
      if(uId) cy.add({group:'edges', data:{source:uId, target:t.id(), relType:'parent-child'}});
      cy.elements().unselect();
    };

    $('disconnectNodes').onclick = () => cy.elements(':selected').remove();
    $('clearBoard').onclick = () => confirm("Clear?") && cy.elements().remove();
    $('toggleTheme').onclick = () => document.body.classList.toggle('light');
    $('searchToggleBtn').onclick = () => $('searchWrapper').style.display = $('searchWrapper').style.display === 'block' ? 'none' : 'block';
    $('searchBar').oninput = e => {
      const q = e.target.value.toLowerCase();
      cy.nodes('[type="person"]').forEach(n => {
        const m = (n.data('firstName')||'').toLowerCase().includes(q) || (n.data('lastName')||'').toLowerCase().includes(q);
        n.style(m && q ? {'border-width':8, 'border-color':'#f59e0b'} : {'border-width':1, 'border-color':'#9ca3af'});
      });
    };

    // --- Import/Export ---
    $('saveTree').onclick = () => {
      const data = { persons: [], unions: [] };
      cy.nodes('[type="person"]').forEach(n => data.persons.push({ id: n.id(), data: n.data(), pos: n.position(), collapsed: cy.getElementById(n.id()+'_branch').hasClass('collapsed-btn') }));
      cy.nodes('[type="union"]').forEach(n => data.unions.push({ id: n.id(), pos: n.position(), 
        partners: n.connectedEdges('[relType="partner"]').sources().map(x=>x.id()),
        children: n.connectedEdges('[relType="parent-child"]').targets().map(x=>x.id()) 
      }));
      const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data)],{type:'application/json'})); a.download='tree.json'; a.click();
    };

    $('importTree').onchange = e => {
      const r = new FileReader();
      r.onload = () => {
        try {
          const d = JSON.parse(r.result);
          cy.batch(() => { // Batch entire import
            cy.elements().remove();
            (d.persons || []).forEach(p => {
              const pData = p.data || p.info || {};
              if(!pData.id && p.id) pData.id = p.id;
              const pPos = p.pos || p.visual?.position || {x:0, y:0};
              addPerson(pData, pPos);
              const isCollapsed = (p.collapsed !== undefined) ? p.collapsed : (p.visual?.isCollapsed);
              if(isCollapsed) cy.getElementById((pData.id || p.id)+'_branch').addClass('collapsed-btn');
            });
            (d.unions || []).forEach(u => {
              const uPos = u.pos || u.visual?.position || {x:0, y:0};
              cy.add({group:'nodes', data:{id:u.id, type:'union'}, position:uPos});
              u.partners.forEach(pid => cy.add({group:'edges', data:{source:pid, target:u.id, relType:'partner'}}));
              u.children.forEach(cid => cy.add({group:'edges', data:{source:u.id, target:cid, relType:'parent-child'}}));
            });
            cy.nodes('.collapsed-btn').forEach(b => getBranch(cy.getElementById(b.data('parentId')), true).addClass('hidden'));
          });
          cy.fit();
        } catch(err) { console.error(err); alert("Import failed: " + err.message); }
      };
      if(e.target.files[0]) r.readAsText(e.target.files[0]);
    };
    window.onresize = () => cy.resize();
  </script>
</body>
</html>