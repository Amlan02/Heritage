<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Heritage – Family Tree Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }
    :root {
      --bg-color: #111827;
      --sidebar-bg: #1f2933;
      --text-color: #f3f4f6;
      --border-color: #374151;
      --input-bg: #111827;
      --input-text: #e5e7eb;
      --cy-bg: #030712;
      --modal-bg: #1f2933;
    }
    body.light {
      --bg-color: #f4f6f8;
      --sidebar-bg: #ffffff;
      --text-color: #111827;
      --border-color: #dcdcdc;
      --input-bg: #ffffff;
      --input-text: #111827;
      --cy-bg: #f9fafb;
      --modal-bg: #ffffff;
    }
    body { 
      margin: 0; 
      display: flex; 
      flex-direction: row; 
      height: 100vh; 
      overflow: hidden; 
      background: var(--bg-color); 
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }
    #sidebar { 
      width: 300px; 
      padding: 16px; 
      background: var(--sidebar-bg); 
      border-right: 1px solid var(--border-color); 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
      z-index: 10; 
      overflow-y: auto;
    }
    #sidebarHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    #sidebar h2 { margin: 0; font-size: 18px; }
    
    #searchToggleBtn {
      background: transparent;
      border: 1px solid var(--border-color);
      width: 36px;
      height: 36px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      color: var(--text-color);
    }
    #searchToggleBtn:hover {
      background: rgba(255,255,255,0.05);
    }
    #searchWrapper {
      display: none;
      margin-top: 8px;
    }

    label { font-size: 13px; opacity: 0.8; }
    input { 
      padding: 8px; 
      font-size: 14px; 
      border: 1px solid var(--border-color); 
      border-radius: 4px; 
      width: 100%; 
      background: var(--input-bg);
      color: var(--input-text);
    }
    button { 
      padding: 12px; 
      border: none; 
      border-radius: 6px; 
      background: #2563eb; 
      color: white; 
      font-size: 14px; 
      cursor: pointer; 
      transition: opacity 0.2s, background 0.2s; 
      width: 100%;
      font-weight: 600;
    }
    button:hover { opacity: 0.9; }
    button.secondary { background: #6b7280; }
    button.danger { background: #ef4444; }
    button:disabled { cursor: not-allowed; opacity: 0.3; }

    #btnMarriage { background-color: #ec4899; color: white; }
    #btnChild { background-color: #86efac; color: #064e3b; }

    #instructions { font-size: 11px; opacity: 0.7; margin-top: auto; line-height: 1.4; padding-top: 20px; }
    #cy { flex: 1; background: var(--cy-bg); position: relative; }
    #modalBackdrop { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.75); 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 1000; 
      padding: 20px;
    }
    #modal { 
      background: var(--modal-bg); 
      width: 500px; 
      max-width: 100%; 
      height: 85vh; 
      border-radius: 12px; 
      padding: 24px; 
      display: flex; 
      flex-direction: column; 
      gap: 12px; 
      box-shadow: 0 20px 50px rgba(0,0,0,0.3); 
      overflow-y: auto;
      position: relative;
    }
    #modalCloseX {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #ef4444;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
      border: none;
      line-height: 1;
      padding: 0;
    }
    #photoContainer {
      position: relative;
      align-self: center;
      width: 120px;
      height: 120px;
      margin-bottom: 10px;
    }
    #modal img { 
      width: 100%; 
      height: 100%; 
      border-radius: 50%; 
      object-fit: cover; 
      background: #374151; 
      border: 3px solid #2563eb;
      display: block;
    }
    #addPhotoBtn {
      position: absolute;
      right: -5px;
      bottom: 5px;
      background: #2563eb;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--modal-bg);
      cursor: pointer;
      font-size: 20px;
      font-weight: bold;
    }
    #validationError { color: #ef4444; font-size: 12px; display: none; text-align: center; }
    #logicToast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #ef4444;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      z-index: 2000;
      display: none;
      font-weight: 500;
    }
    @media (max-width: 768px) {
      body { flex-direction: column; }
      #sidebar { width: 100%; height: auto; max-height: 40vh; border-right: none; border-bottom: 1px solid var(--border-color); }
      #modal { width: 100%; height: 90vh; }
    }
  </style>
</head>
<body class="dark">
  <div id="sidebar">
    <div id="sidebarHeader">
      <h2>Heritage Tree</h2>
      <button id="searchToggleBtn" title="Search Ancestors">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" x1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </button>
    </div>
    
    <div id="searchWrapper">
      <label>Find Ancestor</label>
      <input id="searchBar" placeholder="Type a name..." />
    </div>

    <hr style="width: 100%; border: 0; border-top: 1px solid var(--border-color); margin: 8px 0;" />
    
    <label>First name</label>
    <input id="firstName" placeholder="First" />
    <label>Last name</label>
    <input id="lastName" placeholder="Last" />
    <label>Birth date</label>
    <input id="birthDate" type="date" />
    <button id="addNode">Create Member</button>

    <div style="margin-top: 16px; display: flex; flex-direction: column; gap: 8px;">
      <button id="btnMarriage" disabled>Marriage</button>
      <button id="btnChild" disabled>Child</button>
    </div>

    <hr style="width: 100%; border: 0; border-top: 1px solid var(--border-color); margin: 8px 0;" />
    
    <button id="autoLayout" class="secondary">Re-Align Tree</button>
    <button id="disconnectNodes" class="secondary" disabled>Remove Item</button>
    <button id="toggleTheme" class="secondary">Toggle Theme</button>
    <div style="display: flex; gap: 8px;">
      <button id="saveTree" class="secondary">Export</button>
      <button id="importTrigger" class="secondary" onclick="document.getElementById('importTree').click()">Import</button>
    </div>
    <input id="importTree" type="file" accept="application/json" style="display: none;" />
    <button id="clearBoard" class="danger" style="margin-top: 8px;">CLEAR BOARD</button>
    
    <div id="instructions">
      <strong>INSTRUCTIONS:</strong><br />
      1. Click to select items (no CTRL needed).<br />
      2. <strong>Marriage:</strong> Select two people, click Marriage.<br />
      3. <strong>Child:</strong> Select the <strong>Union Dot</strong> then the <strong>Child</strong>, click Child.<br />
      4. <strong>Re-Align:</strong> Automatically organizes marriages side-by-side with children below.
    </div>
  </div>
  <div id="cy"></div>
  <div id="logicToast">Operation failed. Check selection logic.</div>
  
  <div id="modalBackdrop">
    <div id="modal">
      <button id="modalCloseX" title="Close">✕</button>
      <h3 style="margin: 0; text-align: center;">Member Details</h3>
      <div id="photoContainer">
        <img id="photoPreview" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" />
        <button id="addPhotoBtn" title="Upload Photo">+</button>
      </div>
      <input id="photoInput" type="file" accept="image/*" style="display: none;" />
      <label>First name</label>
      <input id="modalFirstName" placeholder="First" />
      <label>Last name</label>
      <input id="modalLastName" placeholder="Last" />
      <label>Birth date</label>
      <input id="modalBirthDate" type="date" />
      <label>Death date</label>
      <input id="modalDeathDate" type="date" />
      <div id="validationError">Chronological error: Death precedes birth.</div>
      <div style="flex-grow: 1;"></div>
      <button id="saveCharacter">Save Changes</button>
      <button id="closeModal" class="secondary">Cancel</button>
      <button id="deleteNode" class="danger">Delete Member</button>
    </div>
  </div>

  <script>
    'use strict';
    let selectionOrder = []; 
    let activeNodeId = null;

    const cy = cytoscape({
      container: document.getElementById('cy'),
      selectionType: 'additive', 
      style: [
        {
          selector: 'node[type="person"]',
          style: {
            'shape': 'round-rectangle',
            'background-color': '#1f2933',
            'border-width': 1,
            'border-color': '#9ca3af',
            'label': 'data(label)',
            'text-wrap': 'wrap',
            'text-max-width': 160,
            'text-valign': 'bottom',
            'text-halign': 'center',
            'text-margin-y': 8,
            'color': '#f9fafb',
            'padding': 10,
            'font-size': 14, 
            'font-weight': 'bold',
            'width': 100,
            'height': 120,
            'z-index': 10
          }
        },
        {
          selector: 'node[type="union"]',
          style: {
            'shape': 'ellipse',
            'width': 14,
            'height': 14,
            'background-color': '#ec4899',
            'z-index': 15,
            'border-width': 2,
            'border-color': '#ffffff'
          }
        },
        {
            selector: 'node[type="union"]:selected',
            style: { 'border-color': '#3b82f6', 'border-width': 4 }
        },
        {
          selector: 'node[photo]',
          style: {
            'background-image': function(node) {
              const p = node.data('photo');
              return (p && p.length > 0) ? p : 'none';
            },
            'background-fit': 'cover',
            'background-image-opacity': function(node) { return node.data('photo') ? 1 : 0; }
          }
        },
        {
          selector: 'node[isDeceased]',
          style: { 'background-color': '#374151', 'border-style': 'double', 'border-width': 3, 'opacity': 0.8 }
        },
        {
          selector: 'node[type="badge"]',
          style: {
            'shape': 'ellipse',
            'width': 22,
            'height': 22,
            'background-color': '#2563eb',
            'color': '#ffffff',
            'font-size': 14,
            'font-weight': 'bold',
            'label': '+',
            'text-valign': 'center',
            'text-halign': 'center',
            'z-index': 20,
            'border-width': 2,
            'border-color': '#ffffff'
          }
        },
        { 
          selector: 'node[type="person"]:selected', 
          style: { 'border-width': 4, 'border-color': '#3b82f6' } 
        },
        {
          selector: 'node.highlight',
          style: { 'border-color': '#fbbf24', 'border-width': 6 }
        },
        { 
          selector: 'edge', 
          style: { 
            'width': 2, 
            'line-color': '#4b5563', 
            'curve-style': 'taxi', 
            'taxi-direction': 'vertical',
            'target-arrow-shape': 'triangle', 
            'target-arrow-color': '#4b5563'
          } 
        },
        {
          selector: 'edge[relType="partner"]',
          style: {
            'line-style': 'solid',
            'target-arrow-shape': 'none',
            'line-color': '#ec4899',
            'width': 3,
            'curve-style': 'straight'
          }
        },
        {
          selector: 'edge:selected',
          style: { 'line-color': '#3b82f6', 'target-arrow-color': '#3b82f6', 'width': 4 }
        }
      ],
      layout: { name: 'preset' }, 
      wheelSensitivity: 0.1
    });

    function updateBadgePosition(personNode) {
      const badge = cy.getElementById(personNode.id() + '_badge');
      if (badge.empty()) return;
      const pos = personNode.position();
      badge.position({ x: pos.x + 50, y: pos.y - 60 });
    }

    function buildLabel(first, ln, birth, death) {
      let labelParts = [];
      const name = [first, ln].filter(x => x && x.trim()).join(' ').trim();
      if (name) labelParts.push(name);
      let lifespan = "";
      if (birth) lifespan += new Date(birth).getFullYear();
      if (death) lifespan += " – " + new Date(death).getFullYear();
      else if (birth) lifespan += " – ";
      if (lifespan) labelParts.push(lifespan);
      return labelParts.join('\n');
    }

    function createBadge(personNode) {
      const badgeId = personNode.id() + '_badge';
      if(cy.getElementById(badgeId).empty()) {
        cy.add({
          group: 'nodes',
          data: { id: badgeId, type: 'badge', parentId: personNode.id() },
          grabbable: false,
          selectable: false
        });
      }
      updateBadgePosition(personNode);
    }

    function showLogicError(msg) {
      const toast = document.getElementById('logicToast');
      if (msg) toast.innerText = msg;
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    cy.on('position', 'node[type="person"]', (evt) => updateBadgePosition(evt.target));

    const addNodeBtn = document.getElementById('addNode');
    const marriageBtn = document.getElementById('btnMarriage');
    const childBtn = document.getElementById('btnChild');
    const disconnectBtn = document.getElementById('disconnectNodes');
    const toggleThemeBtn = document.getElementById('toggleTheme');
    const autoLayoutBtn = document.getElementById('autoLayout');
    const searchToggleBtn = document.getElementById('searchToggleBtn');
    const searchWrapper = document.getElementById('searchWrapper');
    const searchBar = document.getElementById('searchBar');
    const saveTreeBtn = document.getElementById('saveTree');
    const importTreeInput = document.getElementById('importTree');
    const clearBoardBtn = document.getElementById('clearBoard');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalFirstName = document.getElementById('modalFirstName');
    const modalLastName = document.getElementById('modalLastName');
    const modalBirthDate = document.getElementById('modalBirthDate');
    const modalDeathDate = document.getElementById('modalDeathDate');
    const validationError = document.getElementById('validationError');
    const photoInput = document.getElementById('photoInput');
    const photoPreview = document.getElementById('photoPreview');
    const saveCharacterBtn = document.getElementById('saveCharacter');
    const closeModalBtn = document.getElementById('closeModal');
    const deleteNodeBtn = document.getElementById('deleteNode');

    function updateActionButtons() {
      const selectedNodes = cy.nodes(':selected');
      const selectedEdges = cy.edges(':selected');
      const count = selectedNodes.length;
      marriageBtn.disabled = count !== 2;
      childBtn.disabled = count !== 2;
      disconnectBtn.disabled = count === 0 && selectedEdges.length === 0;
    }

    cy.on('select unselect', 'node, edge', updateActionButtons);

    searchToggleBtn.addEventListener('click', () => {
        const isVisible = window.getComputedStyle(searchWrapper).display === 'block';
        searchWrapper.style.display = isVisible ? 'none' : 'block';
        if (!isVisible) searchBar.focus();
        else { searchBar.value = ''; cy.nodes().removeClass('highlight'); }
    });

    searchBar.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      cy.nodes('[type="person"]').forEach(node => {
        const match = (node.data('label') || '').toLowerCase().includes(query);
        query && match ? node.addClass('highlight') : node.removeClass('highlight');
      });
    });

    function handleAddNode() {
      const f = document.getElementById('firstName');
      const l = document.getElementById('lastName');
      const b = document.getElementById('birthDate');
      
      if (!f.value.trim() && !l.value.trim()) {
        showLogicError("Identity required. Enter names.");
        return;
      }
      
      const uniqueId = 'p_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
      const newPerson = cy.add({
        group: 'nodes',
        data: { 
          id: uniqueId, 
          type: 'person', 
          label: buildLabel(f.value, l.value, b.value, ''), 
          firstName: f.value, 
          lastName: l.value, 
          birthDate: b.value, 
          deathDate: '', 
          isDeceased: false, 
          photo: '' 
        },
        position: { x: 100 + Math.random() * 50, y: 100 + Math.random() * 50 }
      });
      
      createBadge(newPerson);
      f.value = ''; l.value = ''; b.value = '';
      updateActionButtons();
    }

    addNodeBtn.addEventListener('click', handleAddNode);

    marriageBtn.addEventListener('click', () => {
      if (selectionOrder.length < 2) return;
      const s = selectionOrder[selectionOrder.length - 2];
      const t = selectionOrder[selectionOrder.length - 1];

      if (!s || !t || s.data('type') !== 'person' || t.data('type') !== 'person') {
          showLogicError("Select two people for marriage.");
          return;
      }

      const unionId = `u_${s.id()}_${t.id()}`;
      const midX = (s.position().x + t.position().x) / 2;
      const midY = (s.position().y + t.position().y) / 2;
      cy.add([
        { group: 'nodes', data: { id: unionId, type: 'union' }, position: { x: midX, y: midY + 80 } },
        { group: 'edges', data: { id: `e_${s.id()}_u`, source: s.id(), target: unionId, relType: 'partner' } },
        { group: 'edges', data: { id: `e_${t.id()}_u`, source: t.id(), target: unionId, relType: 'partner' } }
      ]);
      cy.elements().unselect();
      selectionOrder = [];
      updateActionButtons();
    });

    childBtn.addEventListener('click', () => {
      if (selectionOrder.length < 2) return;
      const s = selectionOrder[selectionOrder.length - 2];
      const t = selectionOrder[selectionOrder.length - 1];
      if (!s || !t) return;
      
      let parentSourceId = null;
      let childTargetId = null;
      if (t.data('type') !== 'person') { showLogicError("Second selection must be the child."); return; }
      childTargetId = t.id();
      
      if (s.data('type') === 'union') {
          parentSourceId = s.id();
      } else if (s.data('type') === 'person') {
          const unionsOfS = s.neighborhood('node[type="union"]');
          if (unionsOfS.length > 0) {
              parentSourceId = unionsOfS.first().id();
          } else {
              const unionId = `u_single_${s.id()}_${Date.now()}`;
              cy.add([
                  { group: 'nodes', data: { id: unionId, type: 'union' }, position: { x: s.position().x, y: s.position().y + 80 } },
                  { group: 'edges', data: { id: `e_${s.id()}_${unionId}`, source: s.id(), target: unionId, relType: 'partner' } }
              ]);
              parentSourceId = unionId;
          }
      }
      
      if (!parentSourceId) return;
      cy.add({ 
        group: 'edges', 
        data: { id: 'ec_' + Date.now(), source: parentSourceId, target: childTargetId, relType: 'parent-child' } 
      });
      cy.elements().unselect();
      selectionOrder = [];
      updateActionButtons();
    });

    autoLayoutBtn.addEventListener('click', () => {
        const H_GAP = 220; const V_GAP = 350; 
        const depthMap = new Map();
        const personNodes = cy.nodes('[type="person"]');
        if (personNodes.length === 0) return;
        personNodes.forEach(n => depthMap.set(n.id(), 0));
        let changed = true;
        while (changed) {
            changed = false;
            personNodes.forEach(node => {
                const nodeId = node.id(); const currentDepth = depthMap.get(nodeId);
                node.incomers('edge[relType="parent-child"]').forEach(e => {
                    const partners = e.source().neighborhood('node[type="person"]');
                    partners.forEach(p => { if (depthMap.get(p.id()) + 1 > currentDepth) { depthMap.set(nodeId, depthMap.get(p.id()) + 1); changed = true; } });
                });
            });
        }
        const levels = {};
        personNodes.forEach(n => { const d = depthMap.get(n.id()); if (!levels[d]) levels[d] = []; levels[d].push(n); });
        Object.keys(levels).forEach(level => {
            const y = 100 + (parseInt(level) * V_GAP);
            levels[level].forEach((node, idx) => { node.position({ x: idx * H_GAP, y }); });
        });
        cy.nodes('[type="union"]').forEach(u => {
            const partners = u.neighborhood('node[type="person"]');
            if (partners.length > 0) u.position({ x: partners.reduce((sum, p) => sum + p.position().x, 0) / partners.length, y: partners[0].position().y + 100 });
        });
        cy.nodes('[type="person"]').forEach(n => updateBadgePosition(n));
        cy.fit(null, 50);
    });

    disconnectBtn.addEventListener('click', () => {
      cy.elements(':selected').remove();
      cy.nodes('node[type="union"]').forEach(u => { if (u.degree() === 0) u.remove(); });
      updateActionButtons();
    });

    clearBoardBtn.addEventListener('click', () => { if (confirm("Delete all data?")) { cy.elements().remove(); selectionOrder = []; updateActionButtons(); } });
    toggleThemeBtn.addEventListener('click', () => document.body.classList.toggle('light'));

    cy.on('tap', 'node[type="badge"]', (evt) => {
      const parent = cy.getElementById(evt.target.data('parentId'));
      if (parent.nonempty()) openModal(parent);
    });

    function openModal(node) {
      activeNodeId = node.id();
      modalFirstName.value = node.data('firstName') || '';
      modalLastName.value = node.data('lastName') || '';
      modalBirthDate.value = node.data('birthDate') || '';
      modalDeathDate.value = node.data('deathDate') || '';
      photoPreview.src = node.data('photo') || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
      validationError.style.display = 'none';
      modalBackdrop.style.display = 'flex';
    }

    document.getElementById('modalCloseX').addEventListener('click', () => modalBackdrop.style.display = 'none');
    closeModalBtn.addEventListener('click', () => modalBackdrop.style.display = 'none');
    
    saveCharacterBtn.addEventListener('click', () => {
      const node = cy.getElementById(activeNodeId);
      const b = modalBirthDate.value; const d = modalDeathDate.value;
      if (b && d && new Date(d) < new Date(b)) { validationError.style.display = 'block'; return; }
      node.data({ 
        firstName: modalFirstName.value, lastName: modalLastName.value, 
        birthDate: b, deathDate: d, isDeceased: !!d, 
        label: buildLabel(modalFirstName.value, modalLastName.value, b, d) 
      });
      updateBadgePosition(node);
      modalBackdrop.style.display = 'none';
    });

    document.getElementById('addPhotoBtn').addEventListener('click', () => photoInput.click());
    photoInput.addEventListener('change', () => {
      const file = photoInput.files[0];
      if (!file) return;
      const r = new FileReader();
      r.onload = () => { photoPreview.src = r.result; cy.getElementById(activeNodeId).data('photo', r.result); };
      r.readAsDataURL(file);
    });

    deleteNodeBtn.addEventListener('click', () => {
      const node = cy.getElementById(activeNodeId);
      const badge = cy.getElementById(activeNodeId + '_badge');
      node.remove(); if (!badge.empty()) badge.remove();
      modalBackdrop.style.display = 'none';
      updateActionButtons();
    });

    saveTreeBtn.addEventListener('click', () => {
      const nodes = cy.nodes().map(n => ({ data: n.data(), position: n.position() }));
      const edges = cy.edges().map(e => ({ data: e.data() }));
      const blob = new Blob([JSON.stringify({ nodes, edges })], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'tree.json'; a.click();
    });

    importTreeInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const r = new FileReader();
      r.onload = () => {
        try {
            const json = JSON.parse(r.result);
            cy.elements().remove();
            selectionOrder = []; 
            
            // Add nodes first
            cy.add(json.nodes.map(n => ({ group: 'nodes', data: n.data, position: n.position })));
            // Then add edges
            cy.add(json.edges.map(e => ({ group: 'edges', data: e.data })));
            
            // Ensure badges are recreated and correctly positioned
            cy.nodes('[type="person"]').forEach(n => createBadge(n));
            
            updateActionButtons();
            cy.fit(null, 50);
        } catch (err) { showLogicError("Import failed. Data corrupt."); }
        importTreeInput.value = ''; 
      };
      r.readAsText(file);
    });

    cy.on('select', 'node', (evt) => {
      const target = evt.target;
      if (!selectionOrder.find(n => n.id() === target.id())) selectionOrder.push(target);
      if (selectionOrder.length > 2) { const first = selectionOrder.shift(); first.unselect(); }
    });
    cy.on('unselect', 'node', (evt) => { selectionOrder = selectionOrder.filter(n => n.id() !== evt.target.id()); });
    window.addEventListener('resize', () => cy.resize());
  </script>
</body>
</html>